# Тестовое задание  
Обеспечить тестирование (QA стенда) для платформы roomybots в составе App server (Win) + DB (PostgreSQL& Linux) + 5 Client (Win Desktop)  
Сервер: roomyS_1_1.msi    
Клиент: roomyC_1_1.deb, roomyD_1_1.pdf  
## Цели:

1. Развернуть инфраструктуру.
2. Выполнить установку необходимых пакетов.
3. Описать методы, инструменты, подходы и тд..

---
Реализовал автоматическое развёртывание и настройку в облаке для демонстрации, в связи с тем, что дома нет подходящего железа (ресурсы, лицензия , регистрация триал версиий продуктов и тд ) для развёртывания в других средах (wmware hyperv proxmox и тд). Вначале опишу что сделано и как, а ниже будет описание решений, инструментов, подходов.
### Реализация в Yandex Cloud

Инструменты которые использовались:     
+ Система с которой производились все манипуляции: Ubuntu 22.04.1 LTS
+ QEMU
+ Packer
+ Консольная утилита от yandex yc
+ S3cmd — консольный клиент (Linux, Mac) для сервисов, поддерживающими HTTP API Amazon S3 для управления бакетом S3 в Cloud
+ Terraform
+ Ansible (установлен доп модуль для winrm и возможности настраивать win хосты)

В Yandex Cloud создан отдельный каталог, сервисный аккаунт с нужными правами, API ключи, в Object Storage создан S3 бакет для хранения образов и других данных (например файлы состояний для terraform).

#### Packer  
Подготовлеы образы с Windows (Win server 2016 и win10) для возможности импортировать в yandex cloud и дальнейшего использования при создании VM.
Действия согласно официальной документации от Yandex:   

+ Установлен QEMU (был ранее установлен).
+ Установить Packer (был ранее был установлен).
+ Packer сборка образа:  
  + Загружен архив с готовыми конфигурациями для Packer, распакован в нужную папку (windows-packer).
  + Загружены драйверы для использвания образа в виртуальной среде. Папки NetKVM, vioserial и viostor скопированы в папку windows-packer/drivers.
+ Настроен конфиг для packer:   
  + Параметр iso_url - путь к вашему дистрибутиву.
  + iso_checksum - данные sha256 образа
+ В блоке cd_files указаны пути к распакованным драйверам для нужной версии ОС, например:   

```
cd_files = [
    "../drivers/netkvm/2k16/amd64/*",
    "../drivers/viostor/2k16/amd64/*",
    "../drivers/vioserial/2k16/amd64/*",
    "../scripts/qemu/*",
    "Autounattend.xml"
  ]  
```
В папку ../scripts/ можно положить также свои скрипты для автоматизации, на данном этапе производится тест работает ли решение в целом.
+ Выполнена сборка (команда "packer build ." )
После,запустится QEMU, можно настроить систему и произвести выключение машины.
После выполнения команды будет создан дисковый образ в формате .qcow2.

+ Полученный образ загружен в ранее созданный Object Storage
"s3cmd --storage-class COLD put packer-w10gui s3://roomy-bucket-s3"

+ Импортирован образ в Compute Cloud для дальнейшего использования
```yc compute image create --name win10 --description win10 --os-type windows --source-uri "url ссылка в бакете где лежит образ qcow2 "```

#### Terraform
+ Установлен провайдер для взаимодействия с yandex cloud, подготовлены конфиги
+ terraform apply отрабатывает успешно: 
  + Автоматически создаётся сеть
  + Создаются подсети
  + Автоматом создаются виртуальные машины с заранеее подготовленными образами с нужными ресурсами (в зависимости от workspace dev, test и тп.)
  + Автоматически добавляется ssh ключ
В итоге все нужные машины запущены и к ним можно подключиться по ssh или rdp , они готовы для настройки:    
<p align="center"> <img src="./assets/yc.jpg"></p> 

### 1. Выбор инфраструктуры:

Выбор решения относительно инфраструктуры, будет обусловлен этим:

1.Изучаем что есть на данный момент, чем пользуется команда, что привычно и знакомо.
Есть ли физический сервер с достаточными ресурсами.
Исть ли облако у компании и какое, с какими возможностями
Есть ли лицензии на платное ПО (гипервизоры , ОС, клиенты и тд.)
Какой бюджет.

Если, например уже есть лизензия VMware vSphere и vCenter Server и есть рабочая среда , накопленный опты использования и тд, то :
Разворачиваем отдельно виртуальные машины изолируем их от той части сети из которой доступ запрещён (отдельная подсеть, VLAN и тд)

Если преимущественно используются продукты Microsoft и есть лицензии, то наверное лучше использовать Microsoft Hyper-V.
Тоже самое, если используется например XenServer и там уже привычнее для всех и есть наработки, покрываются все потребности и нет проблем, то это решение.

Если ничего, то что выше описано нет:

Нужно быстро подготовить, развернуть среду без особых требований к масштабам (как по ресурсам, задачам, объёмам, надежности стабильности, управлению, возможностям и тд. ) и не для продакшена, я бы выбрал ProxMox.
Причина выбора Proxmox - уже сталкивался с данным гипервизором, для моих задач показался более удобным, гибким , а также :
Это дистрибутив Linux на основе Debian (с Debian сталкивался больше, хорошо разито общество, форумы, более быстрый поиск решений проблем, больше информации и тд,)
Открытый исходный код, бесплатное решение , есть возможности его дорабатывать "под себя", расширять и тд.
Для решения небольших задач, домашнего сервера и не для большого бизнеса, более выгодный вариант в отличии, например дорогостоящей реализации VMware среды.
Есть возможность реализовать резервное копирование, клонирование машин, шаблоны, Vlan,Firewall,балансировку, создать кластер и тд.

Для серъёзного бизнес решения, отказоустойчивости,возможности масштабирования и надежности, наверное лидирует VMware.
---
### Инструменты, методы:

Подготовка инфраструктуры:
В случае если это разовая настройка и подготовка среды, можно сделать всё вручную (разве что клонировать полностью одинаковые настроенные машины)

Для подготовки инфраструктуры если часто приходится разворачивать тестовую среду, периодически приходится собирать образы операционных систем на базе Linux, используются Vagrant , облако и тд:

Я бы выбрал Packer и Terraform

Packer:
Автоматизация и быстрое создание идентичных, настроенных образов, с помощью одного шаблона Packer.
Ускорение создания  инстанса в облаке или виртуалке для разработчика из готового образа
Образ виртуальной машины будет готов заранее и всегда соответствовать нужному набору ПО

Далее, собранный , проверенный, настроенный образ с необходимым ПО, нужными версиями (можно сделать заранее несколько образов по шаблонам, которые часто используются или будут использоваться) используем напрямую для загрузки в облако или в свою виртуальную среду, либо используем для Terraform и разворачиваем инфраструктуру на основе подготовленных образов.

Terraform:
+  позволяет описать инфраструктуру как код, автоматизировать подготовку среды, создание виртуальных, описания ресурсов сетевых компонентов, настройка сети, проброс ssh ключей.
+  Возможность изменять параметры виртуальных машин, удалять, создавать новые, запускать , останавливать, расширять дисковое пространство и тд. В зависимости от конфигураций terraform.
+  Переиспользовать код, избавиться от возможных ошибок ручной настройки.
+  Скорость развертывания и идентичность, постоянность.
+  Можем сразу же проверить, что и в каком порядке будет добавлено, в каком конечном состоянии будет та или иная виртуальная машина или виртуальная сеть.
+  Возможность описывать большинство популярных облачных платформ.
+  Управлять несколькими облачными провайдерами и распространять инфраструктуру между ними для повышения отказоустойчивости (меняется провайдер для отдельного облака или виртуальной среды и используется своя конфигурация)
+  Удобное использование для создания демо-стендов под тестирование и отладку ПО.
+  Удобно читать и корректировать конфигурацию другим участника процесса.

Автоматизация установки ПО и настройки серверов:
В случае если нужна разовая настройка, это происходит очень редко, одинаковые машины, одинаковые системы и тд :
В плане установки дополнительного ПО : можно использовать для Windows автоматизацию с помощью скриптов, особенно если уже есть успешное применение , закрытие потребностей. (PowerShell Desired State Configuration, обычные скрипты PowerShell или bat файлы, Winrm для удаленного управления и тд.) если они понятны для всех участников (кто будет это использовать и участвовать в процессе). Для Linux соответсвенно - bash скрипты, python, если нужна голая система и только установить недостающие несколько пакетов, то вообще однострочники вполне справятся, одной командой.

Я бы выбрал Ansible для автоматизации настройки сервера, потому что:

Знаком с данным инструментом, он показал себя эфэективным для решения рутинных задач , преимущественно, конечно для Linux дистрибутивов.

PowerShell скрипты могут быть достаточно разрозненными, сложными и если их написал отдельный человек и только он разбирается как это всё работает, могут быть проблемы. Может быть не просто их читать другим специалистам.
YAML-конфиги которые использует Ansible более понятны, структуированы.
Решение идентичных проблем можно заменить общими ролями, которые можно переиспользовать.
Можно (нужно) создать репозиторий, где лежат роли, плейбуки, документация как это работает, описание.
Т.е. в едином месте описана настройка сервером, машин, в ввиде кода, который достаточно удобно читать и понимать всем участникам.

Проверить успешность деплоя можно в единой точке. Хорошо работает debug ролей, можно понять на каком этапе произошла ошибка или не отработала задача (по каждому тегу или переменной в которой записывается статус, можно посмотреть причину )
Все участники знают где искать логи и могут их читать.

Также можно использовать, запускать скрипты и в самом Ansible, но сразу видеть результат отработки и перепроверять выполнилась ли задача успешно.

Есть много уже готовых официальных решений (роли, плейбуки) которые можно переделывать под себя, переиспользвать.
Хорошая документация с описанием решения многих часто встречающихся задач.
Есть возможность шифровать кртически важные данные (пароли, секреты).

Если подготовить правильно роли, можно автоматически с помощью условий (если используется конретная ОС на клиенте, то применять конкретные задачи именно для этой ОС) т.е. можно установить нужные пакеты и выполнить настройку одновременно на несколько разных клиентах и каждый будет настроен по своему , но через использование одного инструмента из одного места запуска используя один и тот же код.

Также через Ansible можно настраивать машины как в облаке, так и практически в любых средах виртуализации и инструментах, например для Vagrant. Например - на хосте разработчика запускается Vagrant , далее прогоняется плейбук с Ansible для конечной настройки созданной виртуальной машины.

---

    
---
